name: Cleanup Old Groups

on:
  # Run every Sunday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

# Prevent concurrent executions
concurrency:
  group: cleanup-old-groups
  cancel-in-progress: false

jobs:
  cleanup:
    name: Delete groups inactive for 30+ days
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run cleanup script
        id: cleanup
        env:
          # Firebase credentials (use service account if available, fallback to individual secrets)
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: npm run cleanup

      # ============================================================
      # TELEGRAM NOTIFICATIONS
      # ============================================================
      # Env√≠a notificaci√≥n a Telegram al finalizar (√©xito o fallo)
      #
      # CONFIGURACI√ìN REQUERIDA:
      # 1. Crear bot con @BotFather en Telegram:
      #    - Env√≠a: /newbot
      #    - Sigue las instrucciones
      #    - Guarda el token que te da
      #
      # 2. Obtener tu Chat ID:
      #    - Env√≠a un mensaje a tu bot
      #    - Visita: https://api.telegram.org/bot<TU_TOKEN>/getUpdates
      #    - Busca "chat":{"id": XXXXXXX
      #    - O usa @userinfobot para obtener tu ID
      #
      # 3. Configurar secretos en GitHub:
      #    - TELEGRAM_BOT_TOKEN: El token de @BotFather
      #    - TELEGRAM_CHAT_ID: Tu Chat ID (n√∫mero)
      #
      # Documentaci√≥n: https://core.telegram.org/bots/api
      # ============================================================

      - name: Send Telegram notification (Success)
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>‚úÖ SplitSimple: Cleanup Exitoso</b>%0A%0Aüßπ El proceso de limpieza de grupos antiguos se complet√≥ correctamente.%0A%0AüìÖ <b>Fecha:</b> $(date -u +'%Y-%m-%d %H:%M:%S UTC')%0Aüîó <b>Ver detalles:</b> ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A%0A<i>Revisa los logs para ver cu√°ntos grupos fueron eliminados.</i>"

      - name: Send Telegram notification (Failure)
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>‚ùå SplitSimple: Error en Cleanup</b>%0A%0A‚ö†Ô∏è El proceso de limpieza ha fallado.%0A%0AüìÖ <b>Fecha:</b> $(date -u +'%Y-%m-%d %H:%M:%S UTC')%0Aüîó <b>Ver logs:</b> ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A%0A<b>Posibles causas:</b>%0A‚Ä¢ Credenciales de Firebase incorrectas%0A‚Ä¢ Problemas de permisos en Firestore%0A‚Ä¢ Error de red o timeout%0A%0A<i>Por favor revisa los logs de GitHub Actions.</i>"
